/* SHOPINPIC.COM loader script
Thu May 7 10:05:03 MSK 2015
*/
var g_globalAreaMapOffset=0;function ShopinpicArea(a,b,c,e){var f=a.img;this.sinpImage=a;this.xScale=c;this.yScale=e;if(this.imgObj=f)this.imgOffset=null,this.data=b,this.areas=[],this.init(this.data)}ShopinpicArea.prototype.remove=function(){for(var a in this.areas)this.areas[a].parentNode.removeChild(this.areas[a]);this.areas=[]};ShopinpicArea.prototype.refresh=function(){this.remove();this.init(this.data)};
ShopinpicArea.prototype.init=function(a){this.imgOffset=this._getAbsolutePosition();this.areas=[];for(i in a)this._addArea(i,a[i])};
ShopinpicArea.prototype._getAbsolutePosition=function(a){a||(a=this.imgObj);var b=0,c=0;window.getComputedStyle&&(b=parseInt(window.getComputedStyle(a,null).getPropertyValue("padding-left")),c=parseInt(window.getComputedStyle(a,null).getPropertyValue("padding-top")));if(a.offsetParent){do b+=a.offsetLeft+a.clientLeft,c+=a.offsetTop+a.clientTop;while(a=a.offsetParent)}return{left:b,top:c}};
ShopinpicArea.prototype._addArea=function(a,b){g_globalAreaMapOffset++;var c=parseInt(this.imgObj.clientWidth);parseInt(this.imgObj.clientHeight);var e=document.createElement("div");this.areas.push(e);var f="areamap_"+g_globalAreaMapOffset;e.setAttribute("id",f);e.setAttribute("class","areamap show");var g=parseInt(this.xScale*b.x),h=0,f=0,d=null;if(window.getComputedStyle)var d=window.getComputedStyle(this.imgObj,null).getPropertyValue("position"),h=parseInt(window.getComputedStyle(this.imgObj,null).getPropertyValue("padding-left")),
f=parseInt(window.getComputedStyle(this.imgObj,null).getPropertyValue("padding-top")),k=parseInt(window.getComputedStyle(this.imgObj,null).getPropertyValue("border-left-width")),l=parseInt(window.getComputedStyle(this.imgObj,null).getPropertyValue("border-top-width")),h=h+k,f="absolute"==d?f+l:f-l;e.style.marginLeft=g+h+"px";g=parseInt(this.yScale*b.y);e.style.marginTop="absolute"==d?g+f+"px":0-this.imgObj.clientHeight+f+g+"px";f=parseInt(this.xScale*b.width);e.style.width=f+"px";f=parseInt(this.yScale*
b.height);e.style.height=f+"px";e.innerHTML="";e.divId=g_globalAreaMapOffset;this.imgObj.parentNode.insertBefore(e,this.imgObj.nextSibling);e.onclick=function(){var a=document.getElementById("areamap_"+this.divId+"_popup");a.style.display=a.style.display&&"none"!=a.style.display?"none":"block"};b.placement||(b.placement="middle_center");f=this.xScale*(parseInt(b.width)-24/this.xScale);d=this.yScale*(parseInt(b.height)-24/this.yScale);"top_left"==b.placement&&(iconTop=iconLeft=0);"top_center"==b.placement&&
(iconLeft=f/2,iconTop=0);"top_right"==b.placement&&(iconLeft=f,iconTop=0);"middle_left"==b.placement&&(iconLeft=0,iconTop=d/2);"middle_center"==b.placement&&(iconLeft=f/2,iconTop=d/2);"middle_right"==b.placement&&(iconLeft=f,iconTop=d/2);"bottom_left"==b.placement&&(iconLeft=0,iconTop=d);"bottom_center"==b.placement&&(iconLeft=f/2,iconTop=d);"bottom_right"==b.placement&&(iconLeft=f,iconTop=d);iconLeft=parseInt(iconLeft);iconTop=parseInt(iconTop);f=document.createElement("div");d="areamap_number areamap_number_"+
g_globalAreaMapOffset;b.theme||(b.theme="target");d="shopinpic_icon shopinpic_"+b.theme+" shopinpic_"+b.theme+"_"+g_globalAreaMapOffset;f.setAttribute("class",d);f.style.left=iconLeft+"px";f.style.top=iconTop+"px";e.appendChild(f);d=document.createElement("div");f="areamap_"+g_globalAreaMapOffset+"_popup";d.setAttribute("id",f);b.showOnLoad&&(d.style.display="block");d.setAttribute("class","areamap_popup background_theme_"+(b.color?b.color:"biege"));g=parseInt(iconLeft+24+2);h=iconLeft-24+10-150;
k="right";k="undefined"===typeof this.sinpImage.sip.popupPositioning?"right":this.sinpImage.sip.popupPositioning;"left"==k&&(g=h);"auto"==k&&(k=parseInt(e.style.marginLeft),k+iconLeft-2-150>c-(k+g+150)&&(g=h));d.style.left=g+"px";d.style.top=iconTop+"px";d.style.width="150px";d.innerHTML="";b.title&&(d.innerHTML+='<div class="title">'+b.title+"</div>");b.alt&&(d.innerHTML+='<div class="text">'+b.alt+"</div>");b.popupHtml&&(d.innerHTML+=b.popupHtml);e.appendChild(d);c=parseInt(d.style.left);d.style.left=
"-10000px";d.style.display="block";parseInt(document.getElementById(f).clientHeight);d.style.left=c+"px";d.style.display="";d.style.opacity=""};var ShopinpicImage=function(a){this.img=a;this.areas=[];this.width=this.height=this.nHeight=this.nWidth=null};ShopinpicImage.prototype.refreshPromo=function(){var a=parseInt(this.img.offsetLeft)+this.img.width-150;this.promoDiv.style.left=a+"px"};
ShopinpicImage.prototype.addPromo=function(){this.promoDiv=document.createElement("div");this.promoDiv.setAttribute("class","sinp_promo");this.promoDiv.innerHTML='Image areas by <a href="http://shopinpic.com/" target="_blank">shopinpic.com</a>';this.refreshPromo();this.img.parentNode.insertBefore(this.promoDiv,this.img.nextSibling)};
ShopinpicImage.prototype.initControlPanel=function(){var a=document.createElement("ul");a.setAttribute("class","sinp_cp");a.style.left=this.img.offsetLeft+"px";a.innerHTML='<li><a href="#" onclick="window.open(\''+this.sip.baseUrl+"imgMap3/?apiKey="+this.sip.apiKey+"&url="+this.img.src+"&callback_url=', '_blank'); return false\">&nbsp;</a></li>";this.img.parentNode.insertBefore(a,this.img.nextSibling)};
ShopinpicImage.prototype.refreshAreas=function(){var a=this.img.width/this.nWidth,b=this.img.height/this.nHeight,c;for(c in this.areas)this.areas[c].xScale=a,this.areas[c].yScale=b,this.areas[c].refresh();this.refreshPromo()};ShopinpicImage.prototype.initAreas=function(a){this.areas=[];a=new ShopinpicArea(this,a,this.img.width/this.nWidth,this.img.height/this.nHeight);this.areas.push(a)};var Shopinpic=function(a){var b="https:"==document.location.protocol?"https://ssl.":"http://www.",c=document.createElement("script");c.src=b+"google-analytics.com/ga.js";c.onload=function(){var a=_gat._getTracker("UA-25646694-2");a._initData();a._trackPageview()};document.body.appendChild(c);if(a.imgCssName){this.baseUrl="http://shopinpic.com/";"undefined"!==typeof a.baseUrl&&(this.baseUrl=a.baseUrl);this.className=a.imgCssName;this.adminMode=a.adminMode;this.minImageWidth=200;"undefined"!==typeof a.minImageWidth&&
(this.minImageWidth=a.minImageWidth);this.minImageHeight=200;"undefined"!==typeof a.minImageHeight&&(this.minImageHeight=a.minImageHeight);this.apiKey=a.apiKey;this.popupPositioning=a.popupPositioning;this.sinpImages=[];var e=this;window.addEventListener?window.addEventListener("resize",function(a){e.onResize(a)}):window.attachEvent&&window.attachEvent("onresize",function(a){e.onResize(a)});this.init()}else alert("Please, define images classes to use ShopInPic")};
document.getElementsByClassName||(document.getElementsByClassName=function(a){for(var b=[],c=this.getElementsByTagName("*"),e=0;e<c.length;e++)-1<(" "+c[e].className+" ").indexOf(" "+a+" ")&&b.push(c[e]);return b});Shopinpic.prototype.onResize=function(a){for(var b in sinp.sinpImages)this.sinpImages[b].refreshAreas()};
function getNaturalWidthHeight(a){var b={nWidth:null,nHeight:null};if(a.naturalWidth&&a.naturalHeight)b.nWidth=a.naturalWidth,b.nHeight=a.naturalHeight;else{var c=new Image;c.src=a.src;b.nWidth=c.width;b.nHeight=c.height;delete c}return b}
Shopinpic.prototype.init=function(){this.sinpImages=[];var a=document.getElementsByClassName(this.className),b=a.length;for(i=0;i<a.length;i++){var c=a[i],e=this;c.onerror=function(){b--;if(0==b)e.onInitialized()};c.onload=function(){var a=new ShopinpicImage(this);a.sip=e;var c=getNaturalWidthHeight(this);a.nWidth=c.nWidth;a.nHeight=c.nHeight;a.width=this.clientWidth;a.height=this.clientHeight;this.clientWidth>e.minImageWidth&&this.clientHeight>e.minImageHeight&&e.sinpImages.push(a);b--;if(0==b)e.onInitialized()};
if(1==c.complete)c.onload()}};Shopinpic.prototype.onInitialized=function(){var a=[],b;for(b in this.sinpImages)this.sinpImages[b].initAreas(),a.push(this.sinpImages[b].img.src);var c=this;this._getDatas(a,function(a){if(a.data)for(var b=0;b<a.data.length;b++){var g=a.data[b];c.sinpImages[g.id].initAreas(g.areas)}});for(b in this.sinpImages)this.sinpImages[b].addPromo(),this.adminMode&&this.sinpImages[b].initControlPanel()};
Shopinpic.prototype._getDatas=function(a,b){for(var c=this.baseUrl+"imgMap3/getDatas.php?apiKey="+this.apiKey,e="",f=0;f<a.length;f++)0<f&&(e+="&"),e+="imagesUrls[]="+a[f];if(e.length){var f=navigator.userAgent,g=99;1<f.indexOf("MSIE")&&(g=parseInt(f.substr(f.indexOf("MSIE")+5,5)));if(10>g){var h=new XDomainRequest;h&&(h.open("POST",c),h.onload=function(){var a=null;window.JSON&&window.JSON.parse?a=window.JSON.parse(h.responseText):eval("jsonObj = "+h.responseText);b(a)},h.send(e))}else{var d=this._createXMLHTTPObject();
d&&(d.open("POST",c,!0),e&&d.setRequestHeader("Content-type","application/x-www-form-urlencoded"),d.onreadystatechange=function(){if(4==d.readyState&&(200==d.status||304==d.status)){var a=null;window.JSON&&window.JSON.parse?a=window.JSON.parse(d.response):eval("jsonObj = "+trim(d.response));b(a)}},4!=d.readyState&&d.send(e))}}};
Shopinpic.prototype._createXMLHTTPObject=function(){this._XMLHttpFactories=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}];for(var a=!1,b=0;b<this._XMLHttpFactories.length;b++){try{a=this._XMLHttpFactories[b]()}catch(c){continue}break}return a};
Shopinpic_extendChildImages=function(a){if(a=document.getElementById(a)){a=a.getElementsByTagName("img");for(var b=0;b<a.length;b++){var c=a[b].getAttribute("class");if(!c||!c.match(/shopinpic/)){var e="shopinpic";c&&null!=c&&(e=c+" "+e);a[b].setAttribute("class",e)}}}};window.Shopinpic=Shopinpic;window.Shopinpic_extendChildImages=Shopinpic_extendChildImages;
