/* SHOPINPIC.COM loader script
Fri Apr 24 11:05:08 MSK 2015
*/
var g_globalAreaMapOffset=0;function ShopinpicArea(b,a,c,d){this.xScale=c;this.yScale=d;if(this.imgObj=b)this.imgOffset=null,this.data=a,this.areas=[],this.init(this.data)}ShopinpicArea.prototype.remove=function(){for(var b in this.areas)this.areas[b].parentNode.removeChild(this.areas[b]);this.areas=[]};ShopinpicArea.prototype.refresh=function(){this.remove();this.init(this.data)};
ShopinpicArea.prototype.init=function(b){this.imgOffset=this._getAbsolutePosition();this.areas=[];for(i in b)this._addArea(i,b[i])};
ShopinpicArea.prototype._getAbsolutePosition=function(b){b||(b=this.imgObj);var a=0,c=0;window.getComputedStyle&&(a=parseInt(window.getComputedStyle(b,null).getPropertyValue("padding-left")),c=parseInt(window.getComputedStyle(b,null).getPropertyValue("padding-top")));if(b.offsetParent){do a+=b.offsetLeft+b.clientLeft,c+=b.offsetTop+b.clientTop;while(b=b.offsetParent)}return{left:a,top:c}};
ShopinpicArea.prototype._addArea=function(b,a){g_globalAreaMapOffset++;parseInt(this.imgObj.clientWidth);parseInt(this.imgObj.clientHeight);var c=document.createElement("div");this.areas.push(c);var d="areamap_"+g_globalAreaMapOffset;c.setAttribute("id",d);c.setAttribute("class","areamap show");var f=parseInt(this.xScale*a.x),h=0,d=0,e=null;if(window.getComputedStyle)var e=window.getComputedStyle(this.imgObj,null).getPropertyValue("position"),h=parseInt(window.getComputedStyle(this.imgObj,null).getPropertyValue("padding-left")),
d=parseInt(window.getComputedStyle(this.imgObj,null).getPropertyValue("padding-top")),g=parseInt(window.getComputedStyle(this.imgObj,null).getPropertyValue("border-left-width")),k=parseInt(window.getComputedStyle(this.imgObj,null).getPropertyValue("border-top-width")),h=h+g,d="absolute"==e?d+k:d-k;c.style.marginLeft=f+h+"px";f=parseInt(this.yScale*a.y);c.style.marginTop="absolute"==e?f+d+"px":0-this.imgObj.clientHeight+d+f+"px";d=parseInt(this.xScale*a.width);c.style.width=d+"px";d=parseInt(this.yScale*
a.height);c.style.height=d+"px";c.innerHTML="";c.divId=g_globalAreaMapOffset;this.imgObj.parentNode.insertBefore(c,this.imgObj.nextSibling);c.onclick=function(){var a=document.getElementById("areamap_"+this.divId+"_popup");a.style.display=a.style.display&&"none"!=a.style.display?"none":"block"};a.placement||(a.placement="middle_center");d=this.xScale*(parseInt(a.width)-24/this.xScale);e=this.yScale*(parseInt(a.height)-24/this.yScale);"top_left"==a.placement&&(iconTop=iconLeft=0);"top_center"==a.placement&&
(iconLeft=d/2,iconTop=0);"top_right"==a.placement&&(iconLeft=d,iconTop=0);"middle_left"==a.placement&&(iconLeft=0,iconTop=e/2);"middle_center"==a.placement&&(iconLeft=d/2,iconTop=e/2);"middle_right"==a.placement&&(iconLeft=d,iconTop=e/2);"bottom_left"==a.placement&&(iconLeft=0,iconTop=e);"bottom_center"==a.placement&&(iconLeft=d/2,iconTop=e);"bottom_right"==a.placement&&(iconLeft=d,iconTop=e);iconLeft=parseInt(iconLeft);iconTop=parseInt(iconTop);d=document.createElement("div");e="areamap_number areamap_number_"+
g_globalAreaMapOffset;a.theme||(a.theme="target");e="shopinpic_icon shopinpic_"+a.theme+" shopinpic_"+a.theme+"_"+g_globalAreaMapOffset;d.setAttribute("class",e);d.style.left=iconLeft+"px";d.style.top=iconTop+"px";c.appendChild(d);e=document.createElement("div");d="areamap_"+g_globalAreaMapOffset+"_popup";e.setAttribute("id",d);a.showOnLoad&&(e.style.display="block");e.setAttribute("class","areamap_popup background_theme_"+(a.color?a.color:"biege"));e.style.left=parseInt(iconLeft+24+2)+"px";e.style.top=
iconTop+"px";e.style.width="150px";e.innerHTML="";a.title&&(e.innerHTML+='<div class="title">'+a.title+"</div>");a.alt&&(e.innerHTML+='<div class="text">'+a.alt+"</div>");a.popupHtml&&(e.innerHTML+=a.popupHtml);c.appendChild(e)};var ShopinpicImage=function(b){this.img=b;this.areas=[];this.width=this.height=this.nHeight=this.nWidth=null};ShopinpicImage.prototype.refreshPromo=function(){var b=parseInt(this.img.offsetLeft)+this.img.width-150;this.promoDiv.style.left=b+"px"};
ShopinpicImage.prototype.addPromo=function(){this.promoDiv=document.createElement("div");this.promoDiv.setAttribute("class","sinp_promo");this.promoDiv.innerHTML='Image areas by <a href="http://shopinpic.com/" target="_blank">shopinpic.com</a>';this.refreshPromo();this.img.parentNode.insertBefore(this.promoDiv,this.img.nextSibling)};
ShopinpicImage.prototype.initControlPanel=function(){var b=document.createElement("ul");b.setAttribute("class","sinp_cp");b.style.left=this.img.offsetLeft+"px";b.innerHTML='<li><a href="#" onclick="window.open(\'http://shopinpic.com/imgMap3/?apiKey='+this.sip.apiKey+"&url="+this.img.src+"&callback_url=', '_blank'); return false\">&nbsp;</a></li>";this.img.parentNode.insertBefore(b,this.img.nextSibling)};
ShopinpicImage.prototype.refreshAreas=function(){var b=this.img.width/this.nWidth,a=this.img.height/this.nHeight,c;for(c in this.areas)this.areas[c].xScale=b,this.areas[c].yScale=a,this.areas[c].refresh();this.refreshPromo()};ShopinpicImage.prototype.initAreas=function(b){this.areas=[];this.areas.push(new ShopinpicArea(this.img,b,this.img.width/this.nWidth,this.img.height/this.nHeight))};var Shopinpic=function(b){var a="https:"==document.location.protocol?"https://ssl.":"http://www.",c=document.createElement("script");c.src=a+"google-analytics.com/ga.js";c.onload=function(){var a=_gat._getTracker("UA-25646694-2");a._initData();a._trackPageview()};document.body.appendChild(c);if(b.imgCssName){this.className=b.imgCssName;this.adminMode=b.adminMode;this.apiKey=b.apiKey;this.sinpImages=[];var d=this;window.addEventListener?window.addEventListener("resize",function(a){d.onResize(a)}):
window.attachEvent&&window.attachEvent("onresize",function(a){d.onResize(a)});this.init()}else alert("Please, define images classes to use ShopInPic")};document.getElementsByClassName||(document.getElementsByClassName=function(b){for(var a=[],c=this.getElementsByTagName("*"),d=0;d<c.length;d++)-1<(" "+c[d].className+" ").indexOf(" "+b+" ")&&a.push(c[d]);return a});Shopinpic.prototype.onResize=function(b){for(var a in sinp.sinpImages)this.sinpImages[a].refreshAreas()};
function getNaturalWidthHeight(b){var a={nWidth:null,nHeight:null};if(b.naturalWidth&&b.naturalHeight)a.nWidth=b.naturalWidth,a.nHeight=b.naturalHeight;else{var c=new Image;c.src=b.src;a.nWidth=c.width;a.nHeight=c.height;delete c}return a}
Shopinpic.prototype.init=function(){this.sinpImages=[];var b=document.getElementsByClassName(this.className),a=b.length;for(i=0;i<b.length;i++){var c=b[i],d=this;c.onerror=function(){a--;if(0==a)d.onInitialized()};c.onload=function(){var b=new ShopinpicImage(this);b.sip=d;var c=getNaturalWidthHeight(this);b.nWidth=c.nWidth;b.nHeight=c.nHeight;b.width=this.clientWidth;b.height=this.clientHeight;200<this.clientWidth&&200<this.clientHeight&&d.sinpImages.push(b);a--;if(0==a)d.onInitialized()};if(1==c.complete)c.onload()}};
Shopinpic.prototype.onInitialized=function(){var b=[],a;for(a in this.sinpImages)this.sinpImages[a].initAreas(),b.push(this.sinpImages[a].img.src);var c=this;this._getDatas(b,function(a){if(a.data)for(var b=0;b<a.data.length;b++){var h=a.data[b];c.sinpImages[h.id].initAreas(h.areas)}});for(a in this.sinpImages)this.sinpImages[a].addPromo(),this.adminMode&&this.sinpImages[a].initControlPanel()};
Shopinpic.prototype._getDatas=function(b,a){for(var c="http://shopinpic.com/imgMap3/getDatas.php?apiKey="+this.apiKey,d="",f=0;f<b.length;f++)0<f&&(d+="&"),d+="imagesUrls[]="+b[f];if(d.length){var f=navigator.userAgent,h=99;1<f.indexOf("MSIE")&&(h=parseInt(f.substr(f.indexOf("MSIE")+5,5)));if(10>h){var e=new XDomainRequest;e&&(e.open("POST",c),e.onload=function(){var b=null;window.JSON&&window.JSON.parse?b=window.JSON.parse(e.responseText):eval("jsonObj = "+e.responseText);a(b)},e.send(d))}else{var g=
this._createXMLHTTPObject();g&&(g.open("POST",c,!0),d&&g.setRequestHeader("Content-type","application/x-www-form-urlencoded"),g.onreadystatechange=function(){if(4==g.readyState&&(200==g.status||304==g.status)){var b=null;window.JSON&&window.JSON.parse?b=window.JSON.parse(g.response):eval("jsonObj = "+trim(g.response));a(b)}},4!=g.readyState&&g.send(d))}}};
Shopinpic.prototype._createXMLHTTPObject=function(){this._XMLHttpFactories=[function(){return new XMLHttpRequest},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Msxml3.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")}];for(var b=!1,a=0;a<this._XMLHttpFactories.length;a++){try{b=this._XMLHttpFactories[a]()}catch(c){continue}break}return b};
Shopinpic_extendChildImages=function(b){if(b=document.getElementById(b)){b=b.getElementsByTagName("img");for(var a=0;a<b.length;a++){var c=b[a].getAttribute("class");if(!c||!c.match(/shopinpic/)){var d="shopinpic";c&&null!=c&&(d=c+" "+d);b[a].setAttribute("class",d)}}}};window.Shopinpic=Shopinpic;window.Shopinpic_extendChildImages=Shopinpic_extendChildImages;
